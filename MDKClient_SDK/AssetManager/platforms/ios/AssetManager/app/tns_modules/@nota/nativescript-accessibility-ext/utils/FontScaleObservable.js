"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var nsApp = require("@nativescript/core/application");
var observable_1 = require("@nativescript/core/data/observable");
var profiling_1 = require("@nativescript/core/profiling");
var trace_1 = require("../trace");
var getClosestValidFontScale = profiling_1.profile('getClosestValidFontScale', function getClosestValidFontScaleImpl(fontScale) {
    fontScale = Number(fontScale) || 1;
    return FontScaleObservable.VALID_FONT_SCALES.sort(function (a, b) { return Math.abs(fontScale - a) - Math.abs(fontScale - b); }).shift();
});
var internalObservable;
var fontScaleChanged = profiling_1.profile('fontScaleChanged', function fontScaleChangedImpl(origFontScale) {
    var cls = "fontScaleChanged(" + origFontScale + ")";
    if (trace_1.isTraceEnabled()) {
        trace_1.writeFontScaleTrace("" + cls);
    }
    var fontScale = getClosestValidFontScale(origFontScale);
    if (trace_1.isTraceEnabled()) {
        trace_1.writeFontScaleTrace(cls + " - settings closest valid value: " + fontScale);
    }
    internalObservable.set(FontScaleObservable.FONT_SCALE, fontScale);
    internalObservable.set(FontScaleObservable.IS_EXTRA_SMALL, fontScale < 0.85);
    internalObservable.set(FontScaleObservable.IS_EXTRA_LARGE, fontScale > 1.5);
});
var sizeMap = new Map([
    [UIContentSizeCategoryExtraSmall, 0.5],
    [UIContentSizeCategorySmall, 0.7],
    [UIContentSizeCategoryMedium, 0.85],
    [UIContentSizeCategoryLarge, 1],
    [UIContentSizeCategoryExtraLarge, 1.15],
    [UIContentSizeCategoryExtraExtraLarge, 1.3],
    [UIContentSizeCategoryExtraExtraExtraLarge, 1.5],
    [UIContentSizeCategoryAccessibilityMedium, 2],
    [UIContentSizeCategoryAccessibilityLarge, 2.5],
    [UIContentSizeCategoryAccessibilityExtraLarge, 3],
    [UIContentSizeCategoryAccessibilityExtraExtraLarge, 3.5],
    [UIContentSizeCategoryAccessibilityExtraExtraExtraLarge, 4],
]);
var contentSizeUpdated = profiling_1.profile('contentSizeUpdated', function contentSizeUpdatedImpl(fontSize) {
    if (sizeMap.has(fontSize)) {
        fontScaleChanged(sizeMap.get(fontSize));
        return;
    }
    if (trace_1.isTraceEnabled()) {
        trace_1.writeFontScaleTrace("fontSize: " + fontSize + " is unknown");
    }
    fontScaleChanged(1);
});
var useIOSFontScale = profiling_1.profile('useIOSFontScale', function useIOSFontScaleImpl() {
    if (nsApp.ios.nativeApp) {
        contentSizeUpdated(nsApp.ios.nativeApp.preferredContentSizeCategory);
    }
    else {
        fontScaleChanged(1);
    }
});
function setupConfigListener(attempt) {
    if (attempt === void 0) { attempt = 0; }
    if (!nsApp.ios.nativeApp) {
        if (attempt > 100) {
            if (trace_1.isTraceEnabled()) {
                trace_1.writeErrorTrace("App didn't become active couldn't enable font scaling");
            }
            fontScaleChanged(1);
            return;
        }
        setTimeout(function () { return setupConfigListener(attempt + 1); }, 1);
        return;
    }
    var fontSizeObserver = nsApp.ios.addNotificationObserver(UIContentSizeCategoryDidChangeNotification, function (args) {
        var fontSize = args.userInfo.valueForKey(UIContentSizeCategoryNewValueKey);
        contentSizeUpdated(fontSize);
    });
    nsApp.on(nsApp.exitEvent, function () {
        nsApp.ios.removeNotificationObserver(fontSizeObserver, UIContentSizeCategoryDidChangeNotification);
        internalObservable = null;
        nsApp.off(nsApp.resumeEvent, useIOSFontScale);
    });
    nsApp.on(nsApp.resumeEvent, useIOSFontScale);
    useIOSFontScale();
}
function ensureObservable() {
    if (internalObservable) {
        return;
    }
    internalObservable = new observable_1.Observable();
    setupConfigListener();
}
var FontScaleObservable = (function (_super) {
    __extends(FontScaleObservable, _super);
    function FontScaleObservable() {
        var _this = _super.call(this) || this;
        _this.fontScale = 1;
        _this.isExtraSmall = false;
        _this.isExtraLarge = false;
        ensureObservable();
        var selfRef = new WeakRef(_this);
        var callback = profiling_1.profile('FontScaleObservable.propertyChangeEvent', function (args) {
            var self = selfRef.get();
            if (self) {
                self.set(args.propertyName, args.value);
                return;
            }
            internalObservable.off(observable_1.Observable.propertyChangeEvent, callback);
        });
        internalObservable.on(observable_1.Observable.propertyChangeEvent, callback);
        var fontScale = internalObservable.get(FontScaleObservable.FONT_SCALE);
        _this.set(FontScaleObservable.IS_EXTRA_SMALL, fontScale < 0.85);
        _this.set(FontScaleObservable.IS_EXTRA_LARGE, fontScale > 1.5);
        _this.set(FontScaleObservable.FONT_SCALE, fontScale);
        return _this;
    }
    Object.defineProperty(FontScaleObservable, "VALID_FONT_SCALES", {
        get: function () {
            return [0.5, 0.7, 0.85, 1, 1.15, 1.3, 1.5, 2, 2.5, 3, 3.5, 4];
        },
        enumerable: true,
        configurable: true
    });
    FontScaleObservable.FONT_SCALE = 'fontScale';
    FontScaleObservable.IS_EXTRA_SMALL = 'isExtraSmall';
    FontScaleObservable.IS_EXTRA_LARGE = 'isExtraSmall';
    return FontScaleObservable;
}(observable_1.Observable));
exports.FontScaleObservable = FontScaleObservable;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRm9udFNjYWxlT2JzZXJ2YWJsZS5pb3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJGb250U2NhbGVPYnNlcnZhYmxlLmlvcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHNEQUF3RDtBQUN4RCxpRUFBb0Y7QUFDcEYsMERBQXVEO0FBQ3ZELGtDQUFnRjtBQUVoRixJQUFNLHdCQUF3QixHQUFHLG1CQUFPLENBQUMsMEJBQTBCLEVBQUUsU0FBUyw0QkFBNEIsQ0FBQyxTQUFpQjtJQUMxSCxTQUFTLEdBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUVuQyxPQUFPLG1CQUFtQixDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxVQUFDLENBQUMsRUFBRSxDQUFDLElBQUssT0FBQSxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsR0FBRyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsR0FBRyxDQUFDLENBQUMsRUFBakQsQ0FBaUQsQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDO0FBQ3pILENBQUMsQ0FBQyxDQUFDO0FBRUgsSUFBSSxrQkFBOEIsQ0FBQztBQUNuQyxJQUFNLGdCQUFnQixHQUFHLG1CQUFPLENBQUMsa0JBQWtCLEVBQUUsU0FBUyxvQkFBb0IsQ0FBQyxhQUFxQjtJQUN0RyxJQUFNLEdBQUcsR0FBRyxzQkFBb0IsYUFBYSxNQUFHLENBQUM7SUFFakQsSUFBSSxzQkFBYyxFQUFFLEVBQUU7UUFDcEIsMkJBQW1CLENBQUMsS0FBRyxHQUFLLENBQUMsQ0FBQztLQUMvQjtJQUVELElBQU0sU0FBUyxHQUFHLHdCQUF3QixDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBRTFELElBQUksc0JBQWMsRUFBRSxFQUFFO1FBQ3BCLDJCQUFtQixDQUFJLEdBQUcseUNBQW9DLFNBQVcsQ0FBQyxDQUFDO0tBQzVFO0lBRUQsa0JBQWtCLENBQUMsR0FBRyxDQUFDLG1CQUFtQixDQUFDLFVBQVUsRUFBRSxTQUFTLENBQUMsQ0FBQztJQUNsRSxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsbUJBQW1CLENBQUMsY0FBYyxFQUFFLFNBQVMsR0FBRyxJQUFJLENBQUMsQ0FBQztJQUM3RSxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsbUJBQW1CLENBQUMsY0FBYyxFQUFFLFNBQVMsR0FBRyxHQUFHLENBQUMsQ0FBQztBQUM5RSxDQUFDLENBQUMsQ0FBQztBQUVILElBQU0sT0FBTyxHQUFHLElBQUksR0FBRyxDQUFpQjtJQUN0QyxDQUFDLCtCQUErQixFQUFFLEdBQUcsQ0FBQztJQUN0QyxDQUFDLDBCQUEwQixFQUFFLEdBQUcsQ0FBQztJQUNqQyxDQUFDLDJCQUEyQixFQUFFLElBQUksQ0FBQztJQUNuQyxDQUFDLDBCQUEwQixFQUFFLENBQUMsQ0FBQztJQUMvQixDQUFDLCtCQUErQixFQUFFLElBQUksQ0FBQztJQUN2QyxDQUFDLG9DQUFvQyxFQUFFLEdBQUcsQ0FBQztJQUMzQyxDQUFDLHlDQUF5QyxFQUFFLEdBQUcsQ0FBQztJQUNoRCxDQUFDLHdDQUF3QyxFQUFFLENBQUMsQ0FBQztJQUM3QyxDQUFDLHVDQUF1QyxFQUFFLEdBQUcsQ0FBQztJQUM5QyxDQUFDLDRDQUE0QyxFQUFFLENBQUMsQ0FBQztJQUNqRCxDQUFDLGlEQUFpRCxFQUFFLEdBQUcsQ0FBQztJQUN4RCxDQUFDLHNEQUFzRCxFQUFFLENBQUMsQ0FBQztDQUM1RCxDQUFDLENBQUM7QUFFSCxJQUFNLGtCQUFrQixHQUFHLG1CQUFPLENBQUMsb0JBQW9CLEVBQUUsU0FBUyxzQkFBc0IsQ0FBQyxRQUFnQjtJQUN2RyxJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLEVBQUU7UUFDekIsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1FBRXhDLE9BQU87S0FDUjtJQUVELElBQUksc0JBQWMsRUFBRSxFQUFFO1FBQ3BCLDJCQUFtQixDQUFDLGVBQWEsUUFBUSxnQkFBYSxDQUFDLENBQUM7S0FDekQ7SUFFRCxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUN0QixDQUFDLENBQUMsQ0FBQztBQUVILElBQU0sZUFBZSxHQUFHLG1CQUFPLENBQUMsaUJBQWlCLEVBQUUsU0FBUyxtQkFBbUI7SUFDN0UsSUFBSSxLQUFLLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRTtRQUN2QixrQkFBa0IsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyw0QkFBNEIsQ0FBQyxDQUFDO0tBQ3RFO1NBQU07UUFDTCxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsQ0FBQztLQUNyQjtBQUNILENBQUMsQ0FBQyxDQUFDO0FBRUgsU0FBUyxtQkFBbUIsQ0FBQyxPQUFXO0lBQVgsd0JBQUEsRUFBQSxXQUFXO0lBQ3RDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRTtRQUN4QixJQUFJLE9BQU8sR0FBRyxHQUFHLEVBQUU7WUFDakIsSUFBSSxzQkFBYyxFQUFFLEVBQUU7Z0JBQ3BCLHVCQUFlLENBQUMsdURBQXVELENBQUMsQ0FBQzthQUMxRTtZQUVELGdCQUFnQixDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRXBCLE9BQU87U0FDUjtRQUdELFVBQVUsQ0FBQyxjQUFNLE9BQUEsbUJBQW1CLENBQUMsT0FBTyxHQUFHLENBQUMsQ0FBQyxFQUFoQyxDQUFnQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBRXRELE9BQU87S0FDUjtJQUVELElBQU0sZ0JBQWdCLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQyx1QkFBdUIsQ0FBQywwQ0FBMEMsRUFBRSxVQUFDLElBQUk7UUFDMUcsSUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsZ0NBQWdDLENBQUMsQ0FBQztRQUM3RSxrQkFBa0IsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUMvQixDQUFDLENBQUMsQ0FBQztJQUVILEtBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLFNBQVMsRUFBRTtRQUN4QixLQUFLLENBQUMsR0FBRyxDQUFDLDBCQUEwQixDQUFDLGdCQUFnQixFQUFFLDBDQUEwQyxDQUFDLENBQUM7UUFDbkcsa0JBQWtCLEdBQUcsSUFBSSxDQUFDO1FBRTFCLEtBQUssQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLFdBQVcsRUFBRSxlQUFlLENBQUMsQ0FBQztJQUNoRCxDQUFDLENBQUMsQ0FBQztJQUVILEtBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLFdBQVcsRUFBRSxlQUFlLENBQUMsQ0FBQztJQUU3QyxlQUFlLEVBQUUsQ0FBQztBQUNwQixDQUFDO0FBRUQsU0FBUyxnQkFBZ0I7SUFDdkIsSUFBSSxrQkFBa0IsRUFBRTtRQUN0QixPQUFPO0tBQ1I7SUFFRCxrQkFBa0IsR0FBRyxJQUFJLHVCQUFVLEVBQUUsQ0FBQztJQUN0QyxtQkFBbUIsRUFBRSxDQUFDO0FBQ3hCLENBQUM7QUFFRDtJQUF5Qyx1Q0FBVTtJQWNqRDtRQUFBLFlBQ0UsaUJBQU8sU0FzQlI7UUEzQmUsZUFBUyxHQUFHLENBQUMsQ0FBQztRQUNkLGtCQUFZLEdBQUcsS0FBSyxDQUFDO1FBQ3JCLGtCQUFZLEdBQUcsS0FBSyxDQUFDO1FBS25DLGdCQUFnQixFQUFFLENBQUM7UUFFbkIsSUFBTSxPQUFPLEdBQUcsSUFBSSxPQUFPLENBQUMsS0FBSSxDQUFDLENBQUM7UUFDbEMsSUFBTSxRQUFRLEdBQUcsbUJBQU8sQ0FBQyx5Q0FBeUMsRUFBRSxVQUFTLElBQXdCO1lBQ25HLElBQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUMzQixJQUFJLElBQUksRUFBRTtnQkFDUixJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUV4QyxPQUFPO2FBQ1I7WUFFRCxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsdUJBQVUsQ0FBQyxtQkFBbUIsRUFBRSxRQUFRLENBQUMsQ0FBQztRQUNuRSxDQUFDLENBQUMsQ0FBQztRQUVILGtCQUFrQixDQUFDLEVBQUUsQ0FBQyx1QkFBVSxDQUFDLG1CQUFtQixFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBRWhFLElBQU0sU0FBUyxHQUFHLGtCQUFrQixDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUN6RSxLQUFJLENBQUMsR0FBRyxDQUFDLG1CQUFtQixDQUFDLGNBQWMsRUFBRSxTQUFTLEdBQUcsSUFBSSxDQUFDLENBQUM7UUFDL0QsS0FBSSxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsQ0FBQyxjQUFjLEVBQUUsU0FBUyxHQUFHLEdBQUcsQ0FBQyxDQUFDO1FBQzlELEtBQUksQ0FBQyxHQUFHLENBQUMsbUJBQW1CLENBQUMsVUFBVSxFQUFFLFNBQVMsQ0FBQyxDQUFDOztJQUN0RCxDQUFDO0lBaENELHNCQUFrQix3Q0FBaUI7YUFBbkM7WUFFRSxPQUFPLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsQ0FBQyxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUNoRSxDQUFDOzs7T0FBQTtJQVBzQiw4QkFBVSxHQUFHLFdBQVcsQ0FBQztJQUN6QixrQ0FBYyxHQUFHLGNBQWMsQ0FBQztJQUNoQyxrQ0FBYyxHQUFHLGNBQWMsQ0FBQztJQW1DekQsMEJBQUM7Q0FBQSxBQXRDRCxDQUF5Qyx1QkFBVSxHQXNDbEQ7QUF0Q1ksa0RBQW1CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgbnNBcHAgZnJvbSAnQG5hdGl2ZXNjcmlwdC9jb3JlL2FwcGxpY2F0aW9uJztcbmltcG9ydCB7IE9ic2VydmFibGUsIFByb3BlcnR5Q2hhbmdlRGF0YSB9IGZyb20gJ0BuYXRpdmVzY3JpcHQvY29yZS9kYXRhL29ic2VydmFibGUnO1xuaW1wb3J0IHsgcHJvZmlsZSB9IGZyb20gJ0BuYXRpdmVzY3JpcHQvY29yZS9wcm9maWxpbmcnO1xuaW1wb3J0IHsgaXNUcmFjZUVuYWJsZWQsIHdyaXRlRXJyb3JUcmFjZSwgd3JpdGVGb250U2NhbGVUcmFjZSB9IGZyb20gJy4uL3RyYWNlJztcblxuY29uc3QgZ2V0Q2xvc2VzdFZhbGlkRm9udFNjYWxlID0gcHJvZmlsZSgnZ2V0Q2xvc2VzdFZhbGlkRm9udFNjYWxlJywgZnVuY3Rpb24gZ2V0Q2xvc2VzdFZhbGlkRm9udFNjYWxlSW1wbChmb250U2NhbGU6IG51bWJlcikge1xuICBmb250U2NhbGUgPSBOdW1iZXIoZm9udFNjYWxlKSB8fCAxO1xuXG4gIHJldHVybiBGb250U2NhbGVPYnNlcnZhYmxlLlZBTElEX0ZPTlRfU0NBTEVTLnNvcnQoKGEsIGIpID0+IE1hdGguYWJzKGZvbnRTY2FsZSAtIGEpIC0gTWF0aC5hYnMoZm9udFNjYWxlIC0gYikpLnNoaWZ0KCk7XG59KTtcblxubGV0IGludGVybmFsT2JzZXJ2YWJsZTogT2JzZXJ2YWJsZTtcbmNvbnN0IGZvbnRTY2FsZUNoYW5nZWQgPSBwcm9maWxlKCdmb250U2NhbGVDaGFuZ2VkJywgZnVuY3Rpb24gZm9udFNjYWxlQ2hhbmdlZEltcGwob3JpZ0ZvbnRTY2FsZTogbnVtYmVyKSB7XG4gIGNvbnN0IGNscyA9IGBmb250U2NhbGVDaGFuZ2VkKCR7b3JpZ0ZvbnRTY2FsZX0pYDtcblxuICBpZiAoaXNUcmFjZUVuYWJsZWQoKSkge1xuICAgIHdyaXRlRm9udFNjYWxlVHJhY2UoYCR7Y2xzfWApO1xuICB9XG5cbiAgY29uc3QgZm9udFNjYWxlID0gZ2V0Q2xvc2VzdFZhbGlkRm9udFNjYWxlKG9yaWdGb250U2NhbGUpO1xuXG4gIGlmIChpc1RyYWNlRW5hYmxlZCgpKSB7XG4gICAgd3JpdGVGb250U2NhbGVUcmFjZShgJHtjbHN9IC0gc2V0dGluZ3MgY2xvc2VzdCB2YWxpZCB2YWx1ZTogJHtmb250U2NhbGV9YCk7XG4gIH1cblxuICBpbnRlcm5hbE9ic2VydmFibGUuc2V0KEZvbnRTY2FsZU9ic2VydmFibGUuRk9OVF9TQ0FMRSwgZm9udFNjYWxlKTtcbiAgaW50ZXJuYWxPYnNlcnZhYmxlLnNldChGb250U2NhbGVPYnNlcnZhYmxlLklTX0VYVFJBX1NNQUxMLCBmb250U2NhbGUgPCAwLjg1KTtcbiAgaW50ZXJuYWxPYnNlcnZhYmxlLnNldChGb250U2NhbGVPYnNlcnZhYmxlLklTX0VYVFJBX0xBUkdFLCBmb250U2NhbGUgPiAxLjUpO1xufSk7XG5cbmNvbnN0IHNpemVNYXAgPSBuZXcgTWFwPHN0cmluZywgbnVtYmVyPihbXG4gIFtVSUNvbnRlbnRTaXplQ2F0ZWdvcnlFeHRyYVNtYWxsLCAwLjVdLFxuICBbVUlDb250ZW50U2l6ZUNhdGVnb3J5U21hbGwsIDAuN10sXG4gIFtVSUNvbnRlbnRTaXplQ2F0ZWdvcnlNZWRpdW0sIDAuODVdLFxuICBbVUlDb250ZW50U2l6ZUNhdGVnb3J5TGFyZ2UsIDFdLFxuICBbVUlDb250ZW50U2l6ZUNhdGVnb3J5RXh0cmFMYXJnZSwgMS4xNV0sXG4gIFtVSUNvbnRlbnRTaXplQ2F0ZWdvcnlFeHRyYUV4dHJhTGFyZ2UsIDEuM10sXG4gIFtVSUNvbnRlbnRTaXplQ2F0ZWdvcnlFeHRyYUV4dHJhRXh0cmFMYXJnZSwgMS41XSxcbiAgW1VJQ29udGVudFNpemVDYXRlZ29yeUFjY2Vzc2liaWxpdHlNZWRpdW0sIDJdLFxuICBbVUlDb250ZW50U2l6ZUNhdGVnb3J5QWNjZXNzaWJpbGl0eUxhcmdlLCAyLjVdLFxuICBbVUlDb250ZW50U2l6ZUNhdGVnb3J5QWNjZXNzaWJpbGl0eUV4dHJhTGFyZ2UsIDNdLFxuICBbVUlDb250ZW50U2l6ZUNhdGVnb3J5QWNjZXNzaWJpbGl0eUV4dHJhRXh0cmFMYXJnZSwgMy41XSxcbiAgW1VJQ29udGVudFNpemVDYXRlZ29yeUFjY2Vzc2liaWxpdHlFeHRyYUV4dHJhRXh0cmFMYXJnZSwgNF0sXG5dKTtcblxuY29uc3QgY29udGVudFNpemVVcGRhdGVkID0gcHJvZmlsZSgnY29udGVudFNpemVVcGRhdGVkJywgZnVuY3Rpb24gY29udGVudFNpemVVcGRhdGVkSW1wbChmb250U2l6ZTogc3RyaW5nKSB7XG4gIGlmIChzaXplTWFwLmhhcyhmb250U2l6ZSkpIHtcbiAgICBmb250U2NhbGVDaGFuZ2VkKHNpemVNYXAuZ2V0KGZvbnRTaXplKSk7XG5cbiAgICByZXR1cm47XG4gIH1cblxuICBpZiAoaXNUcmFjZUVuYWJsZWQoKSkge1xuICAgIHdyaXRlRm9udFNjYWxlVHJhY2UoYGZvbnRTaXplOiAke2ZvbnRTaXplfSBpcyB1bmtub3duYCk7XG4gIH1cblxuICBmb250U2NhbGVDaGFuZ2VkKDEpO1xufSk7XG5cbmNvbnN0IHVzZUlPU0ZvbnRTY2FsZSA9IHByb2ZpbGUoJ3VzZUlPU0ZvbnRTY2FsZScsIGZ1bmN0aW9uIHVzZUlPU0ZvbnRTY2FsZUltcGwoKSB7XG4gIGlmIChuc0FwcC5pb3MubmF0aXZlQXBwKSB7XG4gICAgY29udGVudFNpemVVcGRhdGVkKG5zQXBwLmlvcy5uYXRpdmVBcHAucHJlZmVycmVkQ29udGVudFNpemVDYXRlZ29yeSk7XG4gIH0gZWxzZSB7XG4gICAgZm9udFNjYWxlQ2hhbmdlZCgxKTtcbiAgfVxufSk7XG5cbmZ1bmN0aW9uIHNldHVwQ29uZmlnTGlzdGVuZXIoYXR0ZW1wdCA9IDApIHtcbiAgaWYgKCFuc0FwcC5pb3MubmF0aXZlQXBwKSB7XG4gICAgaWYgKGF0dGVtcHQgPiAxMDApIHtcbiAgICAgIGlmIChpc1RyYWNlRW5hYmxlZCgpKSB7XG4gICAgICAgIHdyaXRlRXJyb3JUcmFjZShgQXBwIGRpZG4ndCBiZWNvbWUgYWN0aXZlIGNvdWxkbid0IGVuYWJsZSBmb250IHNjYWxpbmdgKTtcbiAgICAgIH1cblxuICAgICAgZm9udFNjYWxlQ2hhbmdlZCgxKTtcblxuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIENvdWxkbid0IGdldCBsYXVuY2hFdmVudCB0byB0cmlnZ2VyLlxuICAgIHNldFRpbWVvdXQoKCkgPT4gc2V0dXBDb25maWdMaXN0ZW5lcihhdHRlbXB0ICsgMSksIDEpO1xuXG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29uc3QgZm9udFNpemVPYnNlcnZlciA9IG5zQXBwLmlvcy5hZGROb3RpZmljYXRpb25PYnNlcnZlcihVSUNvbnRlbnRTaXplQ2F0ZWdvcnlEaWRDaGFuZ2VOb3RpZmljYXRpb24sIChhcmdzKSA9PiB7XG4gICAgY29uc3QgZm9udFNpemUgPSBhcmdzLnVzZXJJbmZvLnZhbHVlRm9yS2V5KFVJQ29udGVudFNpemVDYXRlZ29yeU5ld1ZhbHVlS2V5KTtcbiAgICBjb250ZW50U2l6ZVVwZGF0ZWQoZm9udFNpemUpO1xuICB9KTtcblxuICBuc0FwcC5vbihuc0FwcC5leGl0RXZlbnQsICgpID0+IHtcbiAgICBuc0FwcC5pb3MucmVtb3ZlTm90aWZpY2F0aW9uT2JzZXJ2ZXIoZm9udFNpemVPYnNlcnZlciwgVUlDb250ZW50U2l6ZUNhdGVnb3J5RGlkQ2hhbmdlTm90aWZpY2F0aW9uKTtcbiAgICBpbnRlcm5hbE9ic2VydmFibGUgPSBudWxsO1xuXG4gICAgbnNBcHAub2ZmKG5zQXBwLnJlc3VtZUV2ZW50LCB1c2VJT1NGb250U2NhbGUpO1xuICB9KTtcblxuICBuc0FwcC5vbihuc0FwcC5yZXN1bWVFdmVudCwgdXNlSU9TRm9udFNjYWxlKTtcblxuICB1c2VJT1NGb250U2NhbGUoKTtcbn1cblxuZnVuY3Rpb24gZW5zdXJlT2JzZXJ2YWJsZSgpIHtcbiAgaWYgKGludGVybmFsT2JzZXJ2YWJsZSkge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGludGVybmFsT2JzZXJ2YWJsZSA9IG5ldyBPYnNlcnZhYmxlKCk7XG4gIHNldHVwQ29uZmlnTGlzdGVuZXIoKTtcbn1cblxuZXhwb3J0IGNsYXNzIEZvbnRTY2FsZU9ic2VydmFibGUgZXh0ZW5kcyBPYnNlcnZhYmxlIHtcbiAgcHVibGljIHN0YXRpYyByZWFkb25seSBGT05UX1NDQUxFID0gJ2ZvbnRTY2FsZSc7XG4gIHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgSVNfRVhUUkFfU01BTEwgPSAnaXNFeHRyYVNtYWxsJztcbiAgcHVibGljIHN0YXRpYyByZWFkb25seSBJU19FWFRSQV9MQVJHRSA9ICdpc0V4dHJhU21hbGwnO1xuXG4gIHB1YmxpYyBzdGF0aWMgZ2V0IFZBTElEX0ZPTlRfU0NBTEVTKCkge1xuICAgIC8vIGlPUyBzdXBwb3J0cyBhIHdpZGVyIG51bWJlciBvZiBmb250IHNjYWxlcyB0aGFuIEFuZHJvaWQgZG9lcy5cbiAgICByZXR1cm4gWzAuNSwgMC43LCAwLjg1LCAxLCAxLjE1LCAxLjMsIDEuNSwgMiwgMi41LCAzLCAzLjUsIDRdO1xuICB9XG5cbiAgcHVibGljIHJlYWRvbmx5IGZvbnRTY2FsZSA9IDE7XG4gIHB1YmxpYyByZWFkb25seSBpc0V4dHJhU21hbGwgPSBmYWxzZTtcbiAgcHVibGljIHJlYWRvbmx5IGlzRXh0cmFMYXJnZSA9IGZhbHNlO1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHN1cGVyKCk7XG5cbiAgICBlbnN1cmVPYnNlcnZhYmxlKCk7XG5cbiAgICBjb25zdCBzZWxmUmVmID0gbmV3IFdlYWtSZWYodGhpcyk7XG4gICAgY29uc3QgY2FsbGJhY2sgPSBwcm9maWxlKCdGb250U2NhbGVPYnNlcnZhYmxlLnByb3BlcnR5Q2hhbmdlRXZlbnQnLCBmdW5jdGlvbihhcmdzOiBQcm9wZXJ0eUNoYW5nZURhdGEpIHtcbiAgICAgIGNvbnN0IHNlbGYgPSBzZWxmUmVmLmdldCgpO1xuICAgICAgaWYgKHNlbGYpIHtcbiAgICAgICAgc2VsZi5zZXQoYXJncy5wcm9wZXJ0eU5hbWUsIGFyZ3MudmFsdWUpO1xuXG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgaW50ZXJuYWxPYnNlcnZhYmxlLm9mZihPYnNlcnZhYmxlLnByb3BlcnR5Q2hhbmdlRXZlbnQsIGNhbGxiYWNrKTtcbiAgICB9KTtcblxuICAgIGludGVybmFsT2JzZXJ2YWJsZS5vbihPYnNlcnZhYmxlLnByb3BlcnR5Q2hhbmdlRXZlbnQsIGNhbGxiYWNrKTtcblxuICAgIGNvbnN0IGZvbnRTY2FsZSA9IGludGVybmFsT2JzZXJ2YWJsZS5nZXQoRm9udFNjYWxlT2JzZXJ2YWJsZS5GT05UX1NDQUxFKTtcbiAgICB0aGlzLnNldChGb250U2NhbGVPYnNlcnZhYmxlLklTX0VYVFJBX1NNQUxMLCBmb250U2NhbGUgPCAwLjg1KTtcbiAgICB0aGlzLnNldChGb250U2NhbGVPYnNlcnZhYmxlLklTX0VYVFJBX0xBUkdFLCBmb250U2NhbGUgPiAxLjUpO1xuICAgIHRoaXMuc2V0KEZvbnRTY2FsZU9ic2VydmFibGUuRk9OVF9TQ0FMRSwgZm9udFNjYWxlKTtcbiAgfVxufVxuIl19